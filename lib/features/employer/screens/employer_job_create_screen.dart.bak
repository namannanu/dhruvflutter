// ignore_for_file: require_trailing_commas, unused_element, use_build_context_synchronously

import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:talent/core/config/payment_config.dart';
import 'package:talent/core/models/models.dart';
import 'package:talent/core/state/app_state.dart';
import 'package:talent/features/employer/screens/job_payment_screen.dart';

class EmployerJobCreateScreen extends StatefulWidget {
  const EmployerJobCreateScreen({super.key});

  @override
  State<EmployerJobCreateScreen> createState() =>
      _EmployerJobCreateScreenState();
}

class _EmployerJobCreateScreenState extends State<EmployerJobCreateScreen> {
  final _formKey = GlobalKey<FormState>();
  BusinessLocation? _selectedBusiness;

  final TextEditingController _locationController = TextEditingController();
  final TextEditingController _hourlyRateController = TextEditingController();
  final TextEditingController _overtimeRateController = TextEditingController();
  final TextEditingController _tagsController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();
  final TextEditingController _requirementsController = TextEditingController();
  final TextEditingController _customTitleController = TextEditingController();

  String? _selectedJobType;
  String _urgency = 'normal';
  final String _frequency = 'once';
  bool _hasOvertime = false;
  bool _requestVerification = false;

  DateTime? _selectedDate;
  TimeOfDay? _startTime;
  TimeOfDay? _endTime;

  final Set<String> _selectedWorkDays = <String>{};
  bool _submitting = false;
  static const int _freeJobQuota = 2;
  static const double _jobPostingFee = 50.0;
  static const Map<String, String> _currencySymbols = {
    'INR': '₹',
    'USD': '\$',
    'EUR': '€',
    'GBP': '£',
  };

  static const List<String> _jobTypes = <String>[
    'Dishwasher',
    'Server',
    'Cashier',
    'Cook',
    'Cleaner',
    'Warehouse Worker',
    'Sales Associate',
    'Food Prep',
    'Host/Hostess',
    'Other',
  ];

  late final List<_TimeOption> _timeOptions;

  @override
  void initState() {
    super.initState();
    final businesses = context.read<AppState>().businesses;
    if (businesses.isNotEmpty) {
      _selectedBusiness = businesses.first;
      _locationController.text = businesses.first.address;
    }
    _timeOptions = _generateTimeOptions();
  }

  String _buildSubmitLabel(AppState appState) {
    if (_submitting) {
      return 'Publishing…';
    }

    final user = appState.currentUser;
    final feeText = _formatFee();

    if (user == null) {
      return 'Continue to publish ($feeText)';
    }

    final bool isPremium = user.isPremium;
    final int freeJobsUsed = user.freeJobsPosted;
    int freeJobsRemaining = _freeJobQuota - freeJobsUsed;
    if (freeJobsRemaining < 0) {
      freeJobsRemaining = 0;
    }

    if (isPremium) {
      return 'Publish job';
    }

    if (freeJobsRemaining > 0) {
      return 'Publish ($freeJobsRemaining free job post${freeJobsRemaining == 1 ? '' : 's'})';
    }

    return 'Continue to publish ($feeText)';
  }

  String? _buildFreeJobMessage(AppState appState) {
    final user = appState.currentUser;
    if (user == null) {
      return null;
    }

    if (user.isPremium) {
      return 'Premium account: unlimited job posts.';
    }

    int remaining = _freeJobQuota - user.freeJobsPosted;
    if (remaining < 0) {
      remaining = 0;
    }
    if (remaining > 0) {
      return '$remaining free job post${remaining == 1 ? '' : 's'} remaining';
    }

    final feeText = _formatFee();
    return 'No free job posts remaining. Publishing costs $feeText.';
  }

  @override
  void dispose() {
    _locationController.dispose();
    _hourlyRateController.dispose();
    _overtimeRateController.dispose();
    _tagsController.dispose();
    _descriptionController.dispose();
    _requirementsController.dispose();
    _customTitleController.dispose();
    super.dispose();
  }

  List<_TimeOption> _generateTimeOptions() {
    final List<_TimeOption> options = <_TimeOption>[];
    for (int hour = 0; hour < 24; hour++) {
      for (int minute = 0; minute < 60; minute += 15) {
        final String value =
            '${hour.toString().padLeft(2, '0')}:${minute.toString().padLeft(2, '0')}';
        options.add(_TimeOption(value, _formatTimeLabel(value)));
      }
    }
    return options;
  }

  String _formatTimeLabel(String time24) {
    final parts = time24.split(':');
    final int hour = int.parse(parts[0]);
    final String minutes = parts[1];
    final String period = hour >= 12 ? 'PM' : 'AM';
    final int hour12 = hour == 0
        ? 12
        : hour > 12
            ? hour - 12
            : hour;
    return '$hour12:$minutes $period';
  }

  String _formatTimeOfDay(TimeOfDay? time) {
    if (time == null) return 'Select time';
    final DateTime now = DateTime.now();
    final DateTime dt =
        DateTime(now.year, now.month, now.day, time.hour, time.minute);
    return DateFormat('HH:mm').format(dt);
  }

  TimeOfDay _parseTimeOfDay(String value) {
    final parts = value.split(':');
    return TimeOfDay(hour: int.parse(parts[0]), minute: int.parse(parts[1]));
  }

  Future<void> _openTimePicker({required bool isStart}) async {
    final TimeOfDay? initial = isStart ? _startTime : _endTime;
    final String? result = await showModalBottomSheet<String>(
      context: context,
      isScrollControlled: true,
      builder: (context) => _TimePickerSheet(
        popularTimes: _popularTimeOptions,
        timeOptions: _timeOptions,
        initialValue: initial != null ? _formatTimeValue(initial) : null,
      ),
    );
    if (result != null) {
      setState(() {
        final TimeOfDay time = _parseTimeOfDay(result);
        if (isStart) {
          _startTime = time;
        } else {
          _endTime = time;
        }
      });
    }
  }

  String _formatTimeValue(TimeOfDay time) {
    return '${time.hour.toString().padLeft(2, '0')}:${time.minute.toString().padLeft(2, '0')}';
  }

  Future<void> _pickDate() async {
    final DateTime initial = _selectedDate ?? DateTime.now();
    final DateTime? date = await showDatePicker(
      context: context,
      initialDate: initial,
      firstDate: DateTime.now().subtract(const Duration(days: 1)),
      lastDate: DateTime.now().add(const Duration(days: 365)),
    );
    if (date != null) {
      setState(() => _selectedDate = date);
    }
  }

  Future<void> _submit() async {
    if (!_formKey.currentState!.validate()) {
      return;
    }
    final businessLocation = _selectedBusiness;
    if (businessLocation == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Add a business location before posting jobs.')),
      );
      return;
    }
    if (_selectedJobType == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Select a job type to continue')),
      );
      return;
    }
    if (_selectedJobType == 'Other' &&
        _customTitleController.text.trim().isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Enter a job title for "Other"')),
      );
      return;
    }
    if (_selectedDate == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Choose a date for the shift')),
      );
      return;
    }
    if (_startTime == null || _endTime == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Select both start and end times')),
      );
      return;
    }
    if ((_frequency == 'weekly' ||
            _frequency == 'custom' ||
            _frequency == 'monthly') &&
        _selectedWorkDays.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Pick at least one work day for recurring jobs')),
      );
      return;
    }
    final double? hourly = double.tryParse(_hourlyRateController.text.trim());
    if (hourly == null || hourly <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Enter a valid hourly rate')),
      );
      return;
    }

    final DateTime startDate = DateTime(
      _selectedDate!.year,
      _selectedDate!.month,
      _selectedDate!.day,
      _startTime!.hour,
      _startTime!.minute,
    );
    DateTime endDate = DateTime(
      _selectedDate!.year,
      _selectedDate!.month,
      _selectedDate!.day,
      _endTime!.hour,
      _endTime!.minute,
    );
    if (!endDate.isAfter(startDate)) {
      endDate = endDate.add(const Duration(days: 1));
    }

    final List<String> tags = <String>[];
    if (_selectedJobType != null && _selectedJobType != 'Other') {
      tags.add(_selectedJobType!.toLowerCase());
    }
    if (_tagsController.text.trim().isNotEmpty) {
      tags.addAll(
        _tagsController.text
            .split(',')
            .map((tag) => tag.trim())
            .where((tag) => tag.isNotEmpty),
      );
    }

    final descriptionBuffer = StringBuffer();
    final description = _descriptionController.text.trim();
    if (description.isNotEmpty) {
      descriptionBuffer.writeln(description);
    } else {
      // Ensure description is not empty for API requirements
      descriptionBuffer.writeln('Job details will be provided.');
    }
    if (_requirementsController.text.trim().isNotEmpty) {
      descriptionBuffer
          .writeln('\nRequirements:\n${_requirementsController.text.trim()}');
    }
    final String finalTitle = _selectedJobType == 'Other'
        ? _customTitleController.text.trim()
        : _selectedJobType!;

    double? overtimeRate;
    if (_hasOvertime) {
      overtimeRate = double.tryParse(_overtimeRateController.text.trim());
      overtimeRate ??= hourly * 1.5;
    }

    final String recurrence;
    switch (_frequency) {
      case 'weekly':
        recurrence = 'weekly';
        break;
      case 'monthly':
        recurrence = 'monthly';
        break;
      case 'custom':
        recurrence = 'custom';
        break;
      default:
        recurrence = 'one-time';
    }

    final String urgencyValue;
    switch (_urgency) {
      case 'urgent':
        urgencyValue = 'high';
        break;
      case 'emergency':
        urgencyValue = 'critical';
        break;
      default:
        urgencyValue = 'medium';
    }

    setState(() => _submitting = true);
    final appState = context.read<AppState>();

    try {
      // Create the job posting first
      final JobPosting job = await appState.createEmployerJob(
        title: finalTitle,
        description: descriptionBuffer.toString(),
        hourlyRate: hourly,
        business: businessLocation,
        start: startDate,
        end: endDate,
        locationDescription: _locationController.text.trim(),
        tags: tags.isEmpty ? null : tags,
        urgency: urgencyValue,
        verificationRequired: _requestVerification,
        hasOvertime: _hasOvertime,
        overtimeRate: overtimeRate,
        recurrence: recurrence,
        workDays: _selectedWorkDays.isEmpty
            ? null
            : _selectedWorkDays.map((day) => day.toLowerCase()).toList(),
      );

      if (!mounted) return;
      if (!job.premiumRequired) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Job posted successfully.')),
        );
        Navigator.of(context).pop(true);
        return;
      }

      final paymentCompleted = await Navigator.of(context).push<bool>(
        MaterialPageRoute(
          builder: (context) => JobPaymentScreen(
            jobId: job.id,
            amount: 50.0,
            currency: 'INR',
          ),
        ),
      );

      if (paymentCompleted == true) {
        Navigator.of(context).pop(true);
      } else {
        setState(() => _submitting = false);
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text(
              'Payment is required to publish this job. You can resume payment from the jobs list.',
            ),
          ),
        );
      }
    } catch (error) {
      if (!mounted) return;

      debugPrint('❌ EmployerJobCreateScreen: job publish failed: $error');

      String errorMessage = 'Failed to create job';
      if (error.toString().contains('description') &&
          error.toString().contains('required')) {
        errorMessage =
            'Job description is required. Please provide a detailed description.';
      } else if (error.toString().contains('validation failed')) {
        errorMessage = 'Please check all required fields and try again.';
      } else if (error.toString().contains('500')) {
        errorMessage =
            'Server error. Please check all fields are properly filled and try again.';
      } else {
        errorMessage = 'Failed to create job: $error';
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(errorMessage),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 4),
        ),
      );
      setState(() => _submitting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final appState = context.watch<AppState>();
    final businesses = appState.businesses;
    final mediaQuery = MediaQuery.of(context);
    final isKeyboardOpen = mediaQuery.viewInsets.bottom > 0;
    final submitLabel = _buildSubmitLabel(appState);
    _buildFreeJobMessage(appState);

    return Scaffold(
      resizeToAvoidBottomInset: true,
      appBar: AppBar(
        automaticallyImplyLeading: false,
        backgroundColor: Colors.white,
        elevation: 0,
        titleSpacing: 0,
        title: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: Row(
            children: [
              IconButton(
                icon: const Icon(Icons.arrow_back),
                onPressed: () => Navigator.of(context).pop(),
              ),
              const SizedBox(width: 8),
              const Expanded(
                child: Text(
                  'Post a Job',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
      body: Stack(
        children: [
          SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildBusinessSelector(businesses),
                    const SizedBox(height: 16),
                    _buildJobTypeSection(),
                    const SizedBox(height: 16),
                    _buildLocationSection(),
                    const SizedBox(height: 16),
                    _buildScheduleSection(),
                    const SizedBox(height: 16),
                    _buildPaySection(appState),
                    const SizedBox(height: 16),
                    _buildUrgencySection(),
                    const SizedBox(height: 16),
                    _buildDescriptionSection(),
                    // Add extra padding for floating button
                    SizedBox(height: isKeyboardOpen ? mediaQuery.viewInsets.bottom + 80 : 80),
                  ],
                ),
              ),
            ),
          ),
          
          // Floating publish button
          Positioned(
            left: 16,
            right: 16,
            bottom: isKeyboardOpen ? mediaQuery.viewInsets.bottom + 16 : 16,
            child: Container(
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(28),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: FloatingActionButton.extended(
                onPressed: _submitting ? null : _submit,
                backgroundColor: Theme.of(context).primaryColor,
                icon: _submitting
                    ? const SizedBox(
                        width: 18,
                        height: 18,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                        ),
                      )
                    : const Icon(Icons.check_circle_outline),
                label: Text(
                  submitLabel,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
                pinned: true,
                automaticallyImplyLeading: false,
                backgroundColor: Colors.white,
                elevation: 0,
                titleSpacing: 0,
                title: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  child: Row(
                    children: [
                      IconButton(
                        icon: const Icon(Icons.arrow_back),
                        onPressed: () => Navigator.of(context).pop(),
                      ),
                      const SizedBox(width: 8),
                      const Expanded(
                        child: Text(
                          'Post a Job',
                          style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
              SliverToBoxAdapter(
                child: Padding(
                  padding: const EdgeInsets.fromLTRB(16, 12, 16, 100),
                  child: Form(
                    key: _formKey,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildBusinessSelector(businesses),
                        const SizedBox(height: 16),
                        _buildJobTypeSection(),
                        const SizedBox(height: 16),
                        _buildLocationSection(),
                        const SizedBox(height: 16),
                        _buildScheduleSection(),
                        const SizedBox(height: 16),
                        _buildPaySection(null),
                        const SizedBox(height: 16),
                        _buildUrgencySection(),
                        const SizedBox(height: 16),
                        _buildDescriptionSection(),
                        // Add extra space for the floating button
                        SizedBox(height: isKeyboardVisible ? mediaQuery.viewInsets.bottom : 0),
                      ],
                    ),
                  ),
                ),
              ),
            ],
          ),
          
          // Floating publish button
          Positioned(
            left: 16,
            right: 16,
            bottom: isKeyboardVisible ? mediaQuery.viewInsets.bottom + 16 : 16,
            child: FloatingActionButton.extended(
              onPressed: _submitting ? null : _submit,
              backgroundColor: Theme.of(context).primaryColor,
              icon: _submitting
                  ? const SizedBox(
                      width: 18,
                      height: 18,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    )
                  : const Icon(Icons.check),
              label: Text(
                submitLabel,
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
        ],
      ),
    );

    if (businesses.isEmpty) {
      _selectedBusiness = null;
    } else if (_selectedBusiness == null ||
        !businesses.contains(_selectedBusiness)) {
      final selected = businesses.first;
      _selectedBusiness = selected;
      if (_locationController.text.trim().isEmpty ||
          _locationController.text == selected.address) {
        _locationController.text = selected.address;
      }
    }

    final mediaQuery = MediaQuery.of(context);
    final isKeyboardOpen = mediaQuery.viewInsets.bottom > 0;
    final submitLabel = _buildSubmitLabel(appState);
    _buildFreeJobMessage(appState);

    return Scaffold(
      resizeToAvoidBottomInset: false,
      body: Stack(
        children: [
          SafeArea(
            child: GestureDetector(
              onTap: () => FocusScope.of(context).unfocus(), // Dismiss keyboard on tap
              child: Form(
                key: _formKey,
                child: CustomScrollView(
                  slivers: [
                    SliverAppBar(
                      pinned: true,
                      automaticallyImplyLeading: false,
                      backgroundColor: Colors.white,
                      elevation: 0,
                      titleSpacing: 0,
                      title: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 16),
                        child: Row(
                          children: [
                            IconButton(
                              icon: const Icon(Icons.arrow_back),
                              onPressed: () => Navigator.of(context).pop(),
                            ),
                            const SizedBox(width: 8),
                            const Expanded(
                              child: Text(
                                'Post a Job',
                                style: TextStyle(
                                  fontSize: 20,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                    SliverToBoxAdapter(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 12,
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            _buildBusinessSelector(businesses),
                            const SizedBox(height: 16),
                            _buildJobTypeSection(),
                            const SizedBox(height: 16),
                            _buildLocationSection(),
                            const SizedBox(height: 16),
                            _buildScheduleSection(),
                            const SizedBox(height: 16),
                            _buildPaySection(null),
                            const SizedBox(height: 16),
                            _buildUrgencySection(),
                            const SizedBox(height: 16),
                            _buildDescriptionSection(),
                            // Add extra padding at bottom to ensure content is visible above FAB
                            SizedBox(height: 80 + (isKeyboardOpen ? mediaQuery.viewInsets.bottom : 0)),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
          Positioned(
            left: 16,
            right: 16,
            bottom: isKeyboardOpen ? mediaQuery.viewInsets.bottom + 16 : 16,
            child: FloatingActionButton.extended(
              onPressed: _submitting ? null : _submit,
              icon: _submitting
                  ? const SizedBox(
                      width: 18,
                      height: 18,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    )
                  : const Icon(Icons.check),
              label: Text(submitLabel),
            ),
          ),
        ],
      ),
          onTap: () {
            // Dismiss keyboard when tapping outside text fields
            FocusScope.of(context).unfocus();
          },
          child: Form(
            key: _formKey,
            child: CustomScrollView(
              slivers: [
                SliverAppBar(
                  pinned: true,
                  automaticallyImplyLeading: false,
                  backgroundColor: Colors.white,
                  elevation: 0,
                  titleSpacing: 0,
                  title: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Row(
                      children: [
                        IconButton(
                          icon: const Icon(Icons.arrow_back),
                          onPressed: () => Navigator.of(context).pop(),
                        ),
                        const SizedBox(width: 8),
                        const Expanded(
                          child: Text(
                            'Post a Job',
                            style: TextStyle(
                                fontSize: 20, fontWeight: FontWeight.w600),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SliverToBoxAdapter(
                  child: Padding(
                    padding: const EdgeInsets.symmetric(
                        horizontal: 16, vertical: 12),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildBusinessSelector(businesses),
                        const SizedBox(height: 16),
                        _buildJobTypeSection(),
                        const SizedBox(height: 16),
                        _buildLocationSection(),
                        const SizedBox(height: 16),
                        _buildScheduleSection(),
                        const SizedBox(height: 16),
                        _buildPaySection(null),
                        const SizedBox(height: 16),
                        _buildUrgencySection(),
                        const SizedBox(height: 16),
                        _buildDescriptionSection(),
                        const SizedBox(height: 80),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
      body: Stack(
        children: [
          SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildBusinessSelector(businesses),
                    const SizedBox(height: 16),
                    _buildJobTypeSection(),
                    const SizedBox(height: 16),
                    _buildLocationSection(),
                    const SizedBox(height: 16),
                    _buildScheduleSection(),
                    const SizedBox(height: 16),
                    _buildPaySection(),
                    const SizedBox(height: 16),
                    _buildUrgencySection(),
                    const SizedBox(height: 16),
                    _buildDescriptionSection(),
                    // Add extra padding at bottom for floating button
                    SizedBox(height: 80),
                  ],
                ),
              ),
            ),
          ),
          
          // Floating publish button that stays above keyboard
          Positioned(
            left: 16,
            right: 16,
            bottom: mediaQuery.viewInsets.bottom + 16,
            child: FloatingActionButton.extended(
              onPressed: _submitting ? null : _submit,
              backgroundColor: Theme.of(context).primaryColor,
              icon: _submitting
                  ? const SizedBox(
                      width: 18,
                      height: 18,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    )
                  : const Icon(Icons.check_circle_outline),
              label: Text(
                submitLabel,
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  String _formatFee() {
    final currencyCode = PaymentConfig.defaultCurrency.toUpperCase();
    final symbol = _currencySymbols[currencyCode] ?? currencyCode;
    final needsSpacing = symbol == currencyCode;
    final amount = _jobPostingFee.toStringAsFixed(0);
    return needsSpacing ? '$symbol $amount' : '$symbol$amount';
  }

  Widget _buildBusinessSelector(List<BusinessLocation> businesses) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Text(
                  'Which business is hiring?',
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                ),
                Text(' *',
                    style: TextStyle(
                        color: Colors.red,
                        fontSize: 16,
                        fontWeight: FontWeight.w600)),
              ],
            ),
            const SizedBox(height: 12),
            if (businesses.isEmpty)
              const Text('Add a business location to publish this job.',
                  style: TextStyle(color: Colors.redAccent))
            else
              DropdownButtonFormField<BusinessLocation>(
                value: _selectedBusiness,
                onChanged: _submitting
                    ? null
                    : (value) {
                        if (value != null) {
                          setState(() {
                            _selectedBusiness = value;
                            if (_locationController.text.trim().isEmpty ||
                                _locationController.text == value.address) {
                              _locationController.text = value.address;
                            }
                          });
                        }
                      },
                items: businesses
                    .map(
                      (business) => DropdownMenuItem<BusinessLocation>(
                        key: ValueKey(business.id),
                        value: business,
                        child: Text(business.name),
                      ),
                    )
                    .toList(),
                decoration: const InputDecoration(
                  border: OutlineInputBorder(),
                  labelText: 'Business',
                ),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildJobTypeSection() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'What type of worker do you need?',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: _jobTypes.map((type) {
                final bool isSelected = _selectedJobType == type;
                return ChoiceChip(
                  label: Text(type),
                  selected: isSelected,
                  onSelected: (selected) {
                    setState(() {
                      _selectedJobType = selected ? type : null;
                    });
                  },
                );
              }).toList(),
            ),
            if (_selectedJobType == 'Other')
              Padding(
                padding: const EdgeInsets.only(top: 12),
                child: TextFormField(
                  controller: _customTitleController,
                  decoration: const InputDecoration(
                    labelText: 'Custom job title',
                    border: OutlineInputBorder(),
                  ),
                ),
              ),
            const SizedBox(height: 12),
            TextFormField(
              controller: _tagsController,
              decoration: const InputDecoration(
                labelText: 'Tags (comma separated)',
                border: OutlineInputBorder(),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPaySection(_JobSuggestion? suggestion) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Icon(Icons.attach_money, size: 20),
                SizedBox(width: 8),
                Text('Hourly rate',
                    style:
                        TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
              ],
            ),
            const SizedBox(height: 12),
            TextFormField(
              controller: _hourlyRateController,
              keyboardType: TextInputType.number,
              decoration: const InputDecoration(
                prefixText: 'USD ',
                labelText: 'Hourly rate',
                border: OutlineInputBorder(),
              ),
              validator: (value) {
                if (value == null || value.trim().isEmpty) {
                  return 'Hourly rate is required';
                }
                if (double.tryParse(value.trim()) == null) {
                  return 'Enter a valid number';
                }
                return null;
              },
            ),
            const SizedBox(height: 12),
            SwitchListTile(
              value: _hasOvertime,
              onChanged: (value) => setState(() => _hasOvertime = value),
              title: const Text('Overtime available'),
              subtitle: const Text('Offer overtime pay for extra hours'),
            ),
            if (_hasOvertime)
              Padding(
                padding: const EdgeInsets.only(top: 8),
                child: TextFormField(
                  controller: _overtimeRateController,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(
                    prefixText: 'USD ',
                    labelText: 'Overtime rate (per hour)',
                    border: OutlineInputBorder(),
                  ),
                ),
              ),
            if (suggestion != null) ...[
              const SizedBox(height: 12),
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.blue.shade50,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Smart suggestions for ${_selectedJobType!}',
                        style: TextStyle(
                            color: Colors.blue.shade900,
                            fontWeight: FontWeight.w600)),
                    const SizedBox(height: 8),
                    Text('Typical rate: \$${suggestion.rate}/hr'),
                    Text('Peak demand: ${suggestion.peak}'),
                    Text('Best locations: ${suggestion.location}'),
                  ],
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildLocationSection() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Icon(Icons.place_outlined, size: 20),
                SizedBox(width: 8),
                Text('Location',
                    style:
                        TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
              ],
            ),
            const SizedBox(height: 12),
            TextFormField(
              controller: _locationController,
              decoration: const InputDecoration(
                labelText: 'Where will the worker report?',
                border: OutlineInputBorder(),
              ),
              validator: (value) {
                if (value == null || value.trim().isEmpty) {
                  return 'Location is required';
                }
                return null;
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildScheduleSection() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Icon(Icons.calendar_today_outlined, size: 20),
                SizedBox(width: 8),
                Text('When do you need them?',
                    style:
                        TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
              ],
            ),
            const SizedBox(height: 12),
            OutlinedButton.icon(
              icon: const Icon(Icons.today),
              label: Text(
                _selectedDate == null
                    ? 'Select date'
                    : DateFormat('EEEE, MMM d, yyyy').format(_selectedDate!),
              ),
              onPressed: _submitting ? null : _pickDate,
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: _submitting
                        ? null
                        : () => _openTimePicker(isStart: true),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.access_time),
                        const SizedBox(width: 8),
                        Text(_formatTimeOfDay(_startTime)),
                      ],
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: OutlinedButton(
                    onPressed: _submitting
                        ? null
                        : () => _openTimePicker(isStart: false),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.access_time_outlined),
                        const SizedBox(width: 8),
                        Text(_formatTimeOfDay(_endTime)),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildUrgencySection() {
    final List<_UrgencyOption> options = <_UrgencyOption>[
      const _UrgencyOption(
          'normal', 'Normal', 'I can wait for the right person'),
      const _UrgencyOption('urgent', 'Urgent', 'I need someone today'),
      const _UrgencyOption(
          'emergency', 'Emergency', 'I need someone right now!'),
    ];

    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text('How urgent is this?',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
            const SizedBox(height: 12),
            ...options.map((option) {
              final bool selected = option.value == _urgency;
              return Padding(
                padding: const EdgeInsets.only(bottom: 8),
                child: ListTile(
                  onTap: () => setState(() => _urgency = option.value),
                  tileColor: selected ? Colors.orange.shade50 : null,
                  shape: RoundedRectangleBorder(
                    side: BorderSide(
                      color: selected ? Colors.orange : Colors.grey.shade300,
                    ),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  title: Text(option.label,
                      style: const TextStyle(fontWeight: FontWeight.w600)),
                  subtitle: Text(option.description),
                  trailing: Icon(
                      selected
                          ? Icons.radio_button_checked
                          : Icons.radio_button_off,
                      color: selected ? Colors.orange : Colors.grey),
                ),
              );
            }),
            const SizedBox(height: 8),
            SwitchListTile.adaptive(
              value: _requestVerification,
              onChanged: (value) =>
                  setState(() => _requestVerification = value),
              title: const Text('Require worker verification'),
              subtitle: const Text('Only verified workers can apply'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDescriptionSection() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Text('Job description',
                    style:
                        TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
                Text(' *',
                    style: TextStyle(
                        color: Colors.red,
                        fontSize: 16,
                        fontWeight: FontWeight.w600)),
              ],
            ),
            const SizedBox(height: 12),
            TextFormField(
              controller: _descriptionController,
              decoration: const InputDecoration(
                border: OutlineInputBorder(),
                hintText:
                    'Describe the tasks, environment, or any special notes…',
              ),
              maxLines: 4,
              textInputAction: TextInputAction.next,
              onFieldSubmitted: (_) {
                // Move focus to the next field (requirements)
                FocusScope.of(context).nextFocus();
              },
              validator: (value) {
                if (value == null || value.trim().isEmpty) {
                  return 'Job description is required';
                }
                return null;
              },
            ),
            const SizedBox(height: 12),
            TextFormField(
              controller: _requirementsController,
              decoration: const InputDecoration(
                border: OutlineInputBorder(),
                hintText: 'List requirements (one per line)',
                labelText: 'Requirements (optional)',
              ),
              maxLines: 3,
              textInputAction: TextInputAction.done,
              onFieldSubmitted: (_) {
                // Dismiss keyboard when user presses "Done"
                FocusScope.of(context).unfocus();
              },
            ),
          ],
        ),
      ),
    );
  }

  List<_TimeOption> get _popularTimeOptions => const <_TimeOption>[
        _TimeOption('06:00', '6:00 AM'),
        _TimeOption('07:00', '7:00 AM'),
        _TimeOption('08:00', '8:00 AM'),
        _TimeOption('09:00', '9:00 AM'),
        _TimeOption('10:00', '10:00 AM'),
        _TimeOption('11:00', '11:00 AM'),
        _TimeOption('12:00', '12:00 PM'),
        _TimeOption('13:00', '1:00 PM'),
        _TimeOption('14:00', '2:00 PM'),
        _TimeOption('15:00', '3:00 PM'),
        _TimeOption('16:00', '4:00 PM'),
        _TimeOption('17:00', '5:00 PM'),
        _TimeOption('18:00', '6:00 PM'),
        _TimeOption('19:00', '7:00 PM'),
        _TimeOption('20:00', '8:00 PM'),
        _TimeOption('21:00', '9:00 PM'),
        _TimeOption('22:00', '10:00 PM'),
      ];
}

class _FrequencyOption {
  const _FrequencyOption(this.value, this.label, this.description, this.icon);

  final String value;
  final String label;
  final String description;
  final IconData icon;
}

class _UrgencyOption {
  const _UrgencyOption(this.value, this.label, this.description);

  final String value;
  final String label;
  final String description;
}

class _JobSuggestion {
  const _JobSuggestion(
      {required this.rate, required this.peak, required this.location});

  final String rate;
  final String peak;
  final String location;
}

class _JobTemplate {
  const _JobTemplate({
    required this.title,
    required this.description,
    required this.requirements,
    required this.suggestedRate,
    required this.frequency,
  });

  final String title;
  final String description;
  final String requirements;
  final String suggestedRate;
  final String frequency;
}

class _TimeOption {
  const _TimeOption(this.value, this.label);

  final String value;
  final String label;
}

class _WorkdayQuickButton extends StatelessWidget {
  const _WorkdayQuickButton({required this.label, required this.onTap});

  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return OutlinedButton(
      onPressed: onTap,
      style: OutlinedButton.styleFrom(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        textStyle: const TextStyle(fontSize: 12, fontWeight: FontWeight.w600),
      ),
      child: Text(label.toUpperCase()),
    );
  }
}

class _TimePickerSheet extends StatelessWidget {
  const _TimePickerSheet({
    required this.popularTimes,
    required this.timeOptions,
    this.initialValue,
  });

  final List<_TimeOption> popularTimes;
  final List<_TimeOption> timeOptions;
  final String? initialValue;

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: Padding(
        padding: const EdgeInsets.only(bottom: 16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Padding(
              padding: const EdgeInsets.fromLTRB(24, 16, 24, 8),
              child: Row(
                children: [
                  const Expanded(
                    child: Text(
                      'Select time',
                      style:
                          TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            SizedBox(
              height: 120,
              child: ListView.builder(
                scrollDirection: Axis.horizontal,
                padding: const EdgeInsets.symmetric(horizontal: 16),
                itemCount: popularTimes.length,
                itemBuilder: (context, index) {
                  final _TimeOption option = popularTimes[index];
                  final bool selected = option.value == initialValue;
                  return Padding(
                    padding: const EdgeInsets.only(right: 8),
                    child: ChoiceChip(
                      label: Text(option.label),
                      selected: selected,
                      onSelected: (_) => Navigator.pop(context, option.value),
                    ),
                  );
                },
              ),
            ),
            const Divider(),
            ListTile(
              leading: const Icon(Icons.access_time),
              title: const Text('Pick custom time'),
              onTap: () async {
                final TimeOfDay now = TimeOfDay.now();
                final TimeOfDay? picked = await showTimePicker(
                  context: context,
                  initialTime: initialValue != null
                      ? TimeOfDay(
                          hour: int.parse(initialValue!.split(':')[0]),
                          minute: int.parse(initialValue!.split(':')[1]),
                        )
                      : now,
                );
                if (picked != null) {
                  final String value =
                      '${picked.hour.toString().padLeft(2, '0')}:${picked.minute.toString().padLeft(2, '0')}';
                  // ignore: use_build_context_synchronously
                  Navigator.pop(context, value);
                }
              },
            ),
            const Divider(),
            Expanded(
              child: ListView.builder(
                itemCount: timeOptions.length,
                itemBuilder: (context, index) {
                  final _TimeOption option = timeOptions[index];
                  final bool selected = option.value == initialValue;
                  return ListTile(
                    onTap: () => Navigator.pop(context, option.value),
                    title: Text(option.label),
                    trailing: selected
                        ? const Icon(Icons.check, color: Colors.blue)
                        : null,
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}
