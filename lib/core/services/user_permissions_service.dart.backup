import 'dart:convert';
import 'package:talent/core/models/u      print(
          'UserPermissionsService: Response status: ${response.statusCode}');
      print('UserPermissionsService: Response headers: ${response.headers}');
      print('UserPermissionsService: Response body: ${response.body}');dart';
import 'package:talent/core/services/http_service.dart';

class UserPermissionsService {
  final HttpService _httpService = HttpService();

  /// Get current user's permissions for a specific business
  Future<List<String>> getUserPermissions(String businessId) async {
    try {
      print(
          'ğŸ”„ UserPermissionsService: Getting permissions for business: $businessId');

      final response = await _httpService.get('/api/auth/permissions',
          queryParams: {'businessId': businessId});

      print(
          'ğŸ“‹ UserPermissionsService: Response status: ${response.statusCode}');
      print('ğŸ“‹ UserPermissionsService: Response body: ${response.body}');

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final permissions = data['permissions'] as List?;

        if (permissions != null) {
          final permissionList = permissions.map((p) => p.toString()).toList();
          print(
              'âœ… UserPermissionsService: Found ${permissionList.length} permissions: $permissionList');
          return permissionList;
        }

        print('âš ï¸ UserPermissionsService: No permissions found in response');
        return <String>[];
      } else {
        print(
            'âŒ UserPermissionsService: Failed to get permissions: ${response.statusCode}');
        print('âŒ UserPermissionsService: Error response: ${response.body}');
        return <String>[];
      }
    } catch (error) {
      print('âŒ UserPermissionsService: Exception getting permissions: $error');
      return <String>[];
    }
  }

  /// Get current user's team member info for a specific business
  Future<TeamMember?> getUserTeamMemberInfo(String businessId) async {
    try {
      print(
          'UserPermissionsService: Getting team member info for business: $businessId');

      // Debug: Log the request details
      print('DEBUG: Base URL: ${_httpService.publicBaseUrl}');
      print('DEBUG: Endpoint: /api/auth/team-member');
      print('DEBUG: Query params: businessId=$businessId');

      final response = await _httpService.get('/api/auth/team-member',
          queryParams: {'businessId': businessId});

      print(
          'ï¿½ UserPermissionsService: Response status: ${response.statusCode}');
      print('ğŸ“‹ UserPermissionsService: Response headers: ${response.headers}');
      print('ğŸ“‹ UserPermissionsService: Response body: ${response.body}');

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        print('ğŸ” DEBUG: Parsed response data: $data');
        
        final teamMemberData = data['teamMember'];

        if (teamMemberData != null) {
          print('ğŸ” DEBUG: Team member data found: $teamMemberData');
          final teamMember =
              TeamMember.fromJson(teamMemberData as Map<String, dynamic>);
          print(
              'UserPermissionsService: Found team member: ${teamMember.user.email} with role: ${teamMember.role}');
          return teamMember;
        }

        print('UserPermissionsService: No team member data found in response');
        print('ğŸ” DEBUG: Response structure: ${data.keys.toList()}');
        return null;
      } else if (response.statusCode == 404) {
        print(
            'â„¹ï¸ UserPermissionsService: User is not a team member of this business');
        print('ğŸ” DEBUG: Business ID: $businessId');
        print('ğŸ” DEBUG: Response body: ${response.body}');
        return null;
      } else if (response.statusCode == 401) {
        print(
            'ğŸ”‘ UserPermissionsService: Authentication failed - token may be expired');
        print('ğŸ” DEBUG: Response body: ${response.body}');
        return null;
      } else {
        print(
            'âŒ UserPermissionsService: Failed to get team member info: ${response.statusCode}');
        print('ğŸ” DEBUG: Response headers: ${response.headers}');
        print('ğŸ” DEBUG: Response body: ${response.body}');
        return null;
      }
    } catch (error, stackTrace) {
      print(
          'âŒ UserPermissionsService: Exception getting team member info: $error');
      print('ğŸ” DEBUG: Stack trace: $stackTrace');
      return null;
    }
  }
}
